pipeline {
    agent any
    
    environment {
        PYTHON_VERSION = '3.11'
        BACKEND_DIR = 'backend'
        BUILD_DIR = '${WORKSPACE}/${BACKEND_DIR}'
        BACKUP_DIR = '${WORKSPACE}/backups'
        SLACK_WEBHOOK_URL = credentials('slack-webhook-url')
        SLACK_CHANNEL = '#ci-cd'
        DEPLOYMENT_URL ='http://localhost:8000'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
    }
    
    triggers {
        // Auto-trigger on every commit
        pollSCM('H/5 * * * *') // Poll every 5 minutes
        // For GitHub/GitLab webhooks, configure in Jenkins UI
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "Checking out code from ${env.GIT_BRANCH}"
                    checkout scm
                    // Get commit information
                    env.GIT_COMMIT_MSG = sh(
                        script: 'git log -1 --pretty=%B',
                        returnStdout: true
                    ).trim()
                    env.GIT_COMMIT_AUTHOR = sh(
                        script: 'git log -1 --pretty=%an',
                        returnStdout: true
                    ).trim()
                    env.GIT_COMMIT_HASH = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                }
            }
        }
        
        stage('Create Backup') {
            steps {
                script {
                    echo "Creating backup of previous build..."
                    sh """
                        mkdir -p ${BACKUP_DIR}
                        if [ -d "${BUILD_DIR}/app" ]; then
                            tar -czf ${BACKUP_DIR}/backend-backup-${BUILD_NUMBER}-${env.GIT_COMMIT_HASH}.tar.gz \
                                -C ${BUILD_DIR} app requirements.txt alembic.ini alembic/
                            echo "Backup created: backend-backup-${BUILD_NUMBER}-${env.GIT_COMMIT_HASH}.tar.gz"
                        fi
                    """
                }
            }
        }
        
        stage('Setup Python') {
            steps {
                script {
                    echo "Setting up Python ${PYTHON_VERSION}"
                    sh '''
                        if command -v python3 &> /dev/null; then
                            echo "Python already installed: $(python3 --version)"
                        else
                            echo "Installing Python..."
                            sudo apt-get update
                            sudo apt-get install -y python3 python3-pip python3-venv
                        fi
                        python3 --version
                        pip3 --version
                    '''
                }
            }
        }
        
        stage('Create Virtual Environment') {
            steps {
                dir(BACKEND_DIR) {
                    script {
                        echo "Creating virtual environment..."
                        sh '''
                            if [ ! -d "venv" ]; then
                                python3 -m venv venv
                            fi
                            . venv/bin/activate
                            pip install --upgrade pip
                        '''
                    }
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                dir(BACKEND_DIR) {
                    script {
                        echo "Installing Python dependencies..."
                        sh '''
                            . venv/bin/activate
                            pip install -r requirements.txt
                        '''
                    }
                }
            }
        }
        
        stage('Database Migrations') {
            steps {
                dir(BACKEND_DIR) {
                    script {
                        echo "Running database migrations..."
                        sh '''
                            . venv/bin/activate
                            alembic upgrade head || echo "Migration failed or already up to date"
                        '''
                    }
                }
            }
        }
        
        stage('Deploy') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'prince'
                }
            }
            steps {
                script {
                    echo "Deploying backend to localhost:8000..."
                    
                    sh '''
                        cd ${BUILD_DIR}
                        . venv/bin/activate
                        
                        # Install PM2 if not available (for process management)
                        if ! command -v pm2 &> /dev/null; then
                            echo "Installing PM2..."
                            npm install -g pm2
                        fi
                        
                        # Stop existing backend process if running
                        pm2 stop medilink-backend || true
                        pm2 delete medilink-backend || true
                        
                        # Ensure port 8000 is available
                        echo "Checking port 8000..."
                        lsof -ti:8000 | xargs kill -9 2>/dev/null || true
                        
                        # Start backend on port 8000 using PM2 with venv python
                        echo "Starting backend on port 8000..."
                        pm2 start venv/bin/python \
                            --name "medilink-backend" \
                            --cwd ${BUILD_DIR} \
                            -- -m uvicorn app.main:app --host 0.0.0.0 --port 8000
                        
                        # Save PM2 process list
                        pm2 save
                        
                        # Display PM2 status
                        pm2 status
                        
                        echo "Backend deployed successfully!"
                        echo "Access backend at: http://localhost:8000"
                        echo "API docs at: http://localhost:8000/docs"
                    '''
                }
            }
            post {
                success {
                    script {
                        echo "Deployment successful!"
                        sendSlackNotification('success')
                    }
                }
                failure {
                    script {
                        echo "Deployment failed!"
                        sendSlackNotification('failure')
                    }
                }
            }
        }
        
        stage('Post-Deployment Monitoring') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'prince'
                }
            }
            steps {
                script {
                    echo "Starting post-deployment monitoring..."
                    // Wait for deployment to stabilize
                    sleep(time: 10, unit: 'SECONDS')
                    
                    // Run health checks
                    sh '''
                        for i in {1..5}; do
                            echo "Health check attempt $i..."
                            curl -f ${DEPLOYMENT_URL}/auth/health || curl -f ${DEPLOYMENT_URL}/docs || true
                            sleep 5
                        done
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "Pipeline completed. Generating summary..."
                generateBuildSummary()
            }
        }
        success {
            script {
                echo "Pipeline succeeded!"
            }
        }
        failure {
            script {
                echo "Pipeline failed!"
                sendSlackNotification('failure')
            }
        }
        cleanup {
            script {
                // Clean up old backups (keep last 10)
                sh """
                    cd ${BACKUP_DIR}
                    ls -t | tail -n +11 | xargs rm -f || true
                """
                // Clean up workspace
                cleanWs()
            }
        }
    }
}

// Helper function to send Slack notifications
def sendSlackNotification(String status) {
    def color = status == 'success' ? 'good' : status == 'failure' ? 'danger' : 'warning'
    def emoji = status == 'success' ? '‚úÖ' : status == 'failure' ? '‚ùå' : '‚ö†Ô∏è'
    
    def message = """
${emoji} *Backend Build ${status.toUpperCase()}*

*Commit:* ${env.GIT_COMMIT_HASH}
*Message:* ${env.GIT_COMMIT_MSG}
*Author:* ${env.GIT_COMMIT_AUTHOR}
*Branch:* ${env.GIT_BRANCH}
*Build:* #${BUILD_NUMBER}
*Duration:* ${currentBuild.durationString}
*Console:* ${env.BUILD_URL}console

${status == 'success' ? 'üéâ Backend deployed successfully on port 8000!' : '‚ö†Ô∏è Build failed. Please check the console logs.'}
""".stripIndent()
    
    sh """
        curl -X POST ${SLACK_WEBHOOK_URL} \\
        -H 'Content-Type: application/json' \\
        -d '{
            "channel": "${SLACK_CHANNEL}",
            "username": "Jenkins CI/CD",
            "icon_emoji": ":jenkins:",
            "attachments": [{
                "color": "${color}",
                "text": "${message.replace('"', '\\"').replace('\n', '\\n')}",
                "mrkdwn_in": ["text"]
            }]
        }'
    """
}

// Helper function to generate build summary
def generateBuildSummary() {
    def summary = """
========================================
Backend CI/CD Pipeline Summary
========================================
Build Number: ${BUILD_NUMBER}
Status: ${currentBuild.currentResult}
Branch: ${env.GIT_BRANCH}
Commit: ${env.GIT_COMMIT_HASH}
Author: ${env.GIT_COMMIT_AUTHOR}
Commit Message: ${env.GIT_COMMIT_MSG}
Duration: ${currentBuild.durationString}
Build URL: ${env.BUILD_URL}
========================================
""".stripIndent()
    
    echo summary
    
    // Write summary to file
    writeFile file: 'build-summary.txt', text: summary
    archiveArtifacts artifacts: 'build-summary.txt', allowEmptyArchive: true
}

