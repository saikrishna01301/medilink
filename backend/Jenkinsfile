// ===================================
// MediLink Backend - Jenkins Pipeline
// ===================================
// This pipeline builds and deploys the backend to GCP

pipeline {
    agent any
    
    environment {
        // Docker Configuration
        IMAGE_NAME = 'medilink-backend'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        GCP_PROJECT_ID = credentials('gcp-project-id')
        GCP_REGION = 'us-central1'
        INSTANCE_NAME = 'medilink-backend-instance'
        
        // GCP Cloud SQL Configuration
        INSTANCE_CONNECTION_NAME = credentials('instance-connection-name')
        DB_USER = credentials('db-user')
        DB_PASSWORD = credentials('db-password')
        DB_NAME = credentials('db-name')
        
        // JWT Configuration
        JWT_SECRET_KEY = credentials('jwt-secret-key')
        JWT_ALGORITHM = 'HS256'
        
        // Email Configuration
        SENDER_EMAIL = credentials('sender-email')
        SENDER_PASSWORD = credentials('sender-password')
        
        // Note: GCP_KEY_FILE handled in withCredentials block
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Checking out code...'
                checkout scm
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo 'üê≥ Building Docker image...'
                dir('backend') {
                    script {
                        sh """
                            docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                            docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
                        """
                    }
                }
            }
        }
        
        stage('Push to GCP Container Registry') {
            steps {
                echo 'üì§ Pushing image to GCR...'
                script {
                    // Use withCredentials to properly handle Secret File
                    withCredentials([file(credentialsId: 'gcp-service-account-key', variable: 'GCP_KEY')]) {
                        sh """
                            # Authenticate with GCP
                            gcloud auth activate-service-account --key-file=\${GCP_KEY}
                            gcloud config set project ${GCP_PROJECT_ID}
                        
                            # Configure Docker for GCR
                            gcloud auth configure-docker
                            
                            # Tag and push image
                            docker tag ${IMAGE_NAME}:${IMAGE_TAG} gcr.io/${GCP_PROJECT_ID}/${IMAGE_NAME}:${IMAGE_TAG}
                            docker tag ${IMAGE_NAME}:${IMAGE_TAG} gcr.io/${GCP_PROJECT_ID}/${IMAGE_NAME}:latest
                            docker push gcr.io/${GCP_PROJECT_ID}/${IMAGE_NAME}:${IMAGE_TAG}
                            docker push gcr.io/${GCP_PROJECT_ID}/${IMAGE_NAME}:latest
                        """
                    }
                }
            }
        }
        
        stage('Deploy to GCP Instance') {
            steps {
                echo 'üöÄ Deploying to GCP instance...'
                script {
                    sh """
                        # Create or update compute instance
                        gcloud compute instances update-container ${INSTANCE_NAME} \
                            --zone=${GCP_REGION}-a \
                            --container-image=gcr.io/${GCP_PROJECT_ID}/${IMAGE_NAME}:${IMAGE_TAG} \
                            --container-env=INSTANCE_CONNECTION_NAME=${INSTANCE_CONNECTION_NAME},\
DB_USER=${DB_USER},\
DB_PASSWORD=${DB_PASSWORD},\
DB_NAME=${DB_NAME},\
JWT_SECRET_KEY=${JWT_SECRET_KEY},\
JWT_ALGORITHM=${JWT_ALGORITHM},\
SENDER_EMAIL=${SENDER_EMAIL},\
SENDER_PASSWORD=${SENDER_PASSWORD},\
GOOGLE_APPLICATION_CREDENTIALS=/secrets/gcp-key.json \
                            --container-mount-host-path=mount-path=/secrets,host-path=/etc/gcp-key,mode=ro \
                            || gcloud compute instances create-with-container ${INSTANCE_NAME} \
                                --zone=${GCP_REGION}-a \
                                --machine-type=e2-medium \
                                --tags=http-server,https-server \
                                --container-image=gcr.io/${GCP_PROJECT_ID}/${IMAGE_NAME}:${IMAGE_TAG} \
                                --container-env=INSTANCE_CONNECTION_NAME=${INSTANCE_CONNECTION_NAME},\
DB_USER=${DB_USER},\
DB_PASSWORD=${DB_PASSWORD},\
DB_NAME=${DB_NAME},\
JWT_SECRET_KEY=${JWT_SECRET_KEY},\
JWT_ALGORITHM=${JWT_ALGORITHM},\
SENDER_EMAIL=${SENDER_EMAIL},\
SENDER_PASSWORD=${SENDER_PASSWORD},\
GOOGLE_APPLICATION_CREDENTIALS=/secrets/gcp-key.json \
                                --container-mount-host-path=mount-path=/secrets,host-path=/etc/gcp-key,mode=ro
                    """
                }
            }
        }
        
        stage('Health Check') {
            steps {
                echo 'üè• Running health check...'
                script {
                    sh """
                        # Get instance external IP
                        INSTANCE_IP=\$(gcloud compute instances describe ${INSTANCE_NAME} \
                            --zone=${GCP_REGION}-a \
                            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
                        
                        # Wait for service to start
                        sleep 30
                        
                        # Health check
                        curl -f http://\${INSTANCE_IP}:8000/auth/health || exit 1
                        echo "‚úÖ Backend is healthy!"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ Backend deployment successful!'
        }
        failure {
            echo '‚ùå Backend deployment failed!'
        }
        cleanup {
            // Clean up old images
            sh "docker rmi ${IMAGE_NAME}:${IMAGE_TAG} || true"
        }
    }
}

