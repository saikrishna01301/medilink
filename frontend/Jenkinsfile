// ~/projects/medihealth/frontend/Jenkinsfile

pipeline {
    agent any
    environment {
        DOCKER_REGISTRY_CREDENTIALS_ID = 'dockerhub-credentials'
        DOCKERHUB_USERNAME = 'virtualviking98'
        DOCKER_IMAGE_NAME = 'medihealth-frontend'
    }
    stages {
        stage('Build & Test') {
            agent {
                 docker {
                    image 'node:18-alpine' 
                    args '-v /var/lib/jenkins/.npm:/.npm'
                } 
            }
            steps {
                dir('frontend') {
                    echo 'Installing dependencies inside the frontend directory...'
                    sh 'npm cache clean --force' 
                    sh 'rm -rf node_modules package-lock.json'
                    sh 'sudo chown -R 111:113 "/.npm"'
                    sh 'npm install'
                }
            }
        }
        stage('Build Docker Image') {
            steps {
                script {
                    def imageTag = env.GIT_COMMIT.take(8)
                    env.FULL_IMAGE_NAME = "${DOCKERHUB_USERNAME}/${DOCKER_IMAGE_NAME}:${imageTag}"
                    echo "Building Docker image: ${env.FULL_IMAGE_NAME}"
                    // Important: The build context is now the frontend subfolder
                    sh "docker build -f frontend/Dockerfile -t ${env.FULL_IMAGE_NAME} frontend/"
                }
            }
        }
        
        stage('Push Docker Image') {
            steps {
                echo "Logging in and pushing image to Docker Hub..."
                withDockerRegistry([url: 'https://index.docker.io/v1/', credentialsId: DOCKER_REGISTRY_CREDENTIALS_ID]) {
                    sh "docker push ${env.FULL_IMAGE_NAME}"
                }
            }
        }
        stage('Deploy') {
            steps {
                echo "Deploying locally built container..."
                sh """
                    # âœ… Create the network if it doesn't already exist
                    docker network create medihealth-net || true
                    
                    docker stop ${DOCKER_IMAGE_NAME} || true
                    docker rm ${DOCKER_IMAGE_NAME} || true
                    docker run -d --name ${DOCKER_IMAGE_NAME} --network medihealth-net -p 80:3000 ${env.FULL_IMAGE_NAME}
                """
            }
        }
    }
    post {
        always {
            cleanWs()
        }
    }
}