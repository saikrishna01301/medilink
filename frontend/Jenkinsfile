// ===================================
// MediLink Frontend - Jenkins Pipeline
// ===================================
// Deploys frontend to GCP Compute Instance

pipeline {
    agent any
    
    environment {
        // Docker Configuration
        IMAGE_NAME = 'medilink-frontend'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        GCP_PROJECT_ID = credentials('gcp-project-id')
        GCP_REGION = 'us-central1'
        INSTANCE_NAME = 'medilink-frontend-instance'
        
        // Backend API URL (your deployed backend)
        NEXT_PUBLIC_API_URL = credentials('backend-api-url')
        NODE_ENV = 'production'
        
        // Note: GCP_KEY_FILE handled in withCredentials block
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Checking out code...'
                checkout scm
            }
            post {
                always {
                    slackSend channel: 'team2', 
                            message: "Frontend Build *${currentBuild.fullDisplayName}* started"
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo 'üê≥ Building Docker image...'
                dir('frontend') {
                    script {
                        sh """
                            docker build \
                                --build-arg NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL} \
                                -t ${IMAGE_NAME}:${IMAGE_TAG} .
                            docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
                        """
                    }
                }
            }
            post {
                success {
                    slackSend channel: 'team2', 
                            color: 'good',
                            message: "Docker Build *${currentBuild.fullDisplayName}* SUCCEEDED"
                }
                failure {
                    slackSend channel: 'team2', 
                            color: 'danger',
                            message: "Docker Build *${currentBuild.fullDisplayName}* FAILED"
                }
            }
        }
        
        stage('Push to GCP Container Registry') {
            steps {
                echo 'üì§ Pushing image to GCR...'
                script {
                    // Use withCredentials to properly handle Secret File
                    withCredentials([file(credentialsId: 'gcp-service-account-key', variable: 'GCP_KEY')]) {
                        sh """
                            # Authenticate with GCP
                            gcloud auth activate-service-account --key-file=\${GCP_KEY}
                            gcloud config set project ${GCP_PROJECT_ID}
                        
                            # Configure Docker for GCR
                            gcloud auth configure-docker
                            
                            # Tag and push image
                            docker tag ${IMAGE_NAME}:${IMAGE_TAG} gcr.io/${GCP_PROJECT_ID}/${IMAGE_NAME}:${IMAGE_TAG}
                            docker tag ${IMAGE_NAME}:${IMAGE_TAG} gcr.io/${GCP_PROJECT_ID}/${IMAGE_NAME}:latest
                            docker push gcr.io/${GCP_PROJECT_ID}/${IMAGE_NAME}:${IMAGE_TAG}
                            docker push gcr.io/${GCP_PROJECT_ID}/${IMAGE_NAME}:latest
                        """
                    }
                }
            }
            post {
                success {
                    slackSend channel: 'team2', 
                            color: 'good',
                            message: "Image pushed to GCR: gcr.io/${GCP_PROJECT_ID}/${IMAGE_NAME}:${IMAGE_TAG}"
                }
            }
        }
        
        stage('Deploy to GCP Instance') {
            steps {
                echo 'üöÄ Deploying to GCP instance...'
                script {
                    sh """
                        # Create or update compute instance
                        gcloud compute instances update-container ${INSTANCE_NAME} \
                            --zone=${GCP_REGION}-a \
                            --container-image=gcr.io/${GCP_PROJECT_ID}/${IMAGE_NAME}:${IMAGE_TAG} \
                            --container-env=NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL},NODE_ENV=${NODE_ENV} \
                            || gcloud compute instances create-with-container ${INSTANCE_NAME} \
                                --zone=${GCP_REGION}-a \
                                --machine-type=e2-medium \
                                --tags=http-server,https-server \
                                --container-image=gcr.io/${GCP_PROJECT_ID}/${IMAGE_NAME}:${IMAGE_TAG} \
                                --container-env=NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL},NODE_ENV=${NODE_ENV}
                    """
                }
            }
        }
        
        stage('Health Check') {
            steps {
                echo 'üè• Running health check...'
                script {
                    sh """
                        # Get instance external IP
                        INSTANCE_IP=\$(gcloud compute instances describe ${INSTANCE_NAME} \
                            --zone=${GCP_REGION}-a \
                            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
                        
                        echo "Frontend deployed at: http://\${INSTANCE_IP}:3000"
                        
                        # Wait for service to start
                        sleep 30
                        
                        # Health check
                        curl -f http://\${INSTANCE_IP}:3000 || exit 1
                        echo "‚úÖ Frontend is healthy!"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ Frontend deployment successful!'
            slackSend channel: 'team2', 
                    color: 'good',
                    message: "Frontend Deployment *${currentBuild.fullDisplayName}* SUCCEEDED ‚úÖ"
        }
        failure {
            echo '‚ùå Frontend deployment failed!'
            slackSend channel: 'team2', 
                    color: 'danger',
                    message: "Frontend Deployment *${currentBuild.fullDisplayName}* FAILED ‚ùå"
        }
        cleanup {
            // Clean up old images
            sh "docker rmi ${IMAGE_NAME}:${IMAGE_TAG} || true"
            // Clean workspace
            cleanWs()
        }
    }
}
