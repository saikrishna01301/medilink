pipeline {
    agent any
    
    environment {
        NODE_VERSION = '18.x'
        FRONTEND_DIR = 'frontend'
        BUILD_DIR = '${WORKSPACE}/${FRONTEND_DIR}'
        BACKUP_DIR = '${WORKSPACE}/backups'
        SLACK_WEBHOOK_URL = credentials('slack-channel-secret')
        SLACK_CHANNEL = '#team2'
        DEPLOYMENT_URL = 'http://localhost:3000'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
    }
    
    triggers {
        // Auto-trigger on every commit
        pollSCM('H/5 * * * *') // Poll every 5 minutes
        // For GitHub/GitLab webhooks, configure in Jenkins UI:
        // Manage Jenkins > Configure System > GitHub/GitLab webhooks
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "Checking out code from ${env.GIT_BRANCH}"
                    checkout scm
                    // Get commit information
                    env.GIT_COMMIT_MSG = sh(
                        script: 'git log -1 --pretty=%B',
                        returnStdout: true
                    ).trim()
                    env.GIT_COMMIT_AUTHOR = sh(
                        script: 'git log -1 --pretty=%an',
                        returnStdout: true
                    ).trim()
                    env.GIT_COMMIT_HASH = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                }
            }
        }
        
        stage('Create Backup') {
            steps {
                script {
                    echo "Creating backup of previous build..."
                    sh """
                        mkdir -p ${BACKUP_DIR}
                        if [ -d "${BUILD_DIR}/.next" ]; then
                            tar -czf ${BACKUP_DIR}/backup-${BUILD_NUMBER}-${env.GIT_COMMIT_HASH}.tar.gz \
                                -C ${BUILD_DIR} .next package.json package-lock.json
                            echo "Backup created: backup-${BUILD_NUMBER}-${env.GIT_COMMIT_HASH}.tar.gz"
                        fi
                    """
                }
            }
        }
        
        stage('Setup Node.js') {
            steps {
                script {
                    echo "Setting up Node.js ${NODE_VERSION}"
                    // Use NodeJS plugin if available, otherwise install manually
                    try {
                        sh '''
                            if command -v node &> /dev/null; then
                                echo "Node.js already installed: $(node --version)"
                                echo "npm version: $(npm --version)"
                            else
                                echo "Installing Node.js..."
                                curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
                                sudo apt-get install -y nodejs
                            fi
                            node --version
                            npm --version
                        '''
                    } catch (Exception e) {
                        echo "Node.js setup failed: ${e.message}"
                        echo "Ensure Node.js is installed on Jenkins server"
                        throw e
                    }
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                dir(FRONTEND_DIR) {
                    script {
                        echo "Installing npm dependencies..."
                        sh 'npm ci --prefer-offline --no-audit'
                    }
                }
            }
        }
        
        stage('Security Audit') {
            steps {
                dir(FRONTEND_DIR) {
                    script {
                        echo "Running security audit..."
                        sh '''
                            node scripts/security-audit.js || true
                            npm audit --audit-level=moderate || true
                        '''
                    }
                }
            }
            post {
                always {
                    script {
                        // Archive security audit results
                        archiveArtifacts artifacts: 'frontend/security-audit-report.json', allowEmptyArchive: true
                    }
                }
            }
        }
        
        stage('Lint') {
            steps {
                dir(FRONTEND_DIR) {
                    script {
                        echo "Running ESLint..."
                        sh 'npm run lint || true'
                    }
                }
            }
        }
        
        stage('Build') {
            steps {
                dir(FRONTEND_DIR) {
                    script {
                        echo "Building Next.js application..."
                        sh '''
                            export NODE_ENV=production
                            npm run build
                        '''
                    }
                }
            }
            post {
                failure {
                    script {
                        echo "Build failed! Sending notification..."
                        sendSlackNotification('failure')
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    echo "Running health check..."
                    dir(FRONTEND_DIR) {
                        sh 'node scripts/health-check.js || true'
                    }
                }
            }
        }
        
        stage('Performance Test') {
            steps {
                script {
                    echo "Running performance tests..."
                    dir(FRONTEND_DIR) {
                        sh 'node scripts/performance-monitor.js || true'
                    }
                }
            }
            post {
                always {
                    script {
                        // Archive performance reports
                        archiveArtifacts artifacts: 'frontend/performance-report.json', allowEmptyArchive: true
                    }
                }
            }
        }
        
        stage('Deploy') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'prince'
                }
            }
            steps {
                script {
                    echo "Deploying frontend to localhost:3000..."
                    
                    sh '''
                        cd ${BUILD_DIR}
                        
                        # Install PM2 if not available (recommended for process management)
                        if ! command -v pm2 &> /dev/null; then
                            echo "Installing PM2..."
                            npm install -g pm2
                        fi
                        
                        # Stop existing frontend process if running
                        pm2 stop medilink-frontend || true
                        pm2 delete medilink-frontend || true
                        
                        # Ensure port 3000 is available
                        echo "Checking port 3000..."
                        lsof -ti:3000 | xargs kill -9 2>/dev/null || true
                        
                        # Start frontend on port 3000
                        echo "Starting frontend on port 3000..."
                        PORT=3000 pm2 start npm --name "medilink-frontend" -- start
                        
                        # Save PM2 process list
                        pm2 save
                        
                        # Display PM2 status
                        pm2 status
                        
                        echo "Frontend deployed successfully!"
                        echo "Access frontend at: http://localhost:3000"
                    '''
                }
            }
            post {
                success {
                    script {
                        echo "Deployment successful!"
                        sendSlackNotification('success')
                    }
                }
                failure {
                    script {
                        echo "Deployment failed!"
                        sendSlackNotification('failure')
                    }
                }
            }
        }
        
        stage('Post-Deployment Monitoring') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'prince'
                }
            }
            steps {
                script {
                    echo "Starting post-deployment monitoring..."
                    // Wait for deployment to stabilize
                    sleep(time: 30, unit: 'SECONDS')
                    
                    // Run health checks
                    sh '''
                        for i in {1..5}; do
                            echo "Health check attempt $i..."
                            curl -f ${DEPLOYMENT_URL}/api/health || curl -f ${DEPLOYMENT_URL} || true
                            sleep 10
                        done
                    '''
                    
                    // Run performance monitoring
                    dir(FRONTEND_DIR) {
                        sh 'node scripts/performance-monitor.js || true'
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "Pipeline completed. Generating summary..."
                generateBuildSummary()
            }
        }
        success {
            script {
                echo "Pipeline succeeded!"
            }
        }
        failure {
            script {
                echo "Pipeline failed!"
                sendSlackNotification('failure')
            }
        }
        cleanup {
            script {
                // Clean up old backups (keep last 10)
                sh """
                    cd ${BACKUP_DIR}
                    ls -t | tail -n +11 | xargs rm -f || true
                """
                // Clean up workspace
                cleanWs()
            }
        }
    }
}

// Helper function to send Slack notifications
def sendSlackNotification(String status) {
    def color = status == 'success' ? 'good' : status == 'failure' ? 'danger' : 'warning'
    def emoji = status == 'success' ? '‚úÖ' : status == 'failure' ? '‚ùå' : '‚ö†Ô∏è'
    
    def message = """
${emoji} *Frontend Build ${status.toUpperCase()}*

*Commit:* ${env.GIT_COMMIT_HASH}
*Message:* ${env.GIT_COMMIT_MSG}
*Author:* ${env.GIT_COMMIT_AUTHOR}
*Branch:* ${env.GIT_BRANCH}
*Build:* #${BUILD_NUMBER}
*Duration:* ${currentBuild.durationString}
*Console:* ${env.BUILD_URL}console

${status == 'success' ? 'üéâ Build deployed successfully!' : '‚ö†Ô∏è Build failed. Please check the console logs.'}
""".stripIndent()
    
    sh """
        curl -X POST ${SLACK_WEBHOOK_URL} \\
        -H 'Content-Type: application/json' \\
        -d '{
            "channel": "${SLACK_CHANNEL}",
            "username": "Jenkins CI/CD",
            "icon_emoji": ":jenkins:",
            "attachments": [{
                "color": "${color}",
                "text": "${message.replace('"', '\\"').replace('\n', '\\n')}",
                "mrkdwn_in": ["text"]
            }]
        }'
    """
}

// Helper function to generate build summary
def generateBuildSummary() {
    def summary = """
========================================
Frontend CI/CD Pipeline Summary
========================================
Build Number: ${BUILD_NUMBER}
Status: ${currentBuild.currentResult}
Branch: ${env.GIT_BRANCH}
Commit: ${env.GIT_COMMIT_HASH}
Author: ${env.GIT_COMMIT_AUTHOR}
Commit Message: ${env.GIT_COMMIT_MSG}
Duration: ${currentBuild.durationString}
Build URL: ${env.BUILD_URL}
========================================
""".stripIndent()
    
    echo summary
    
    // Write summary to file
    writeFile file: 'build-summary.txt', text: summary
    archiveArtifacts artifacts: 'build-summary.txt', allowEmptyArchive: true
}

